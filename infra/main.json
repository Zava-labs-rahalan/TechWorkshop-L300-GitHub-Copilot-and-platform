{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "17859146474763133463"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "westus3",
      "metadata": {
        "description": "The Azure region for all resources"
      }
    },
    "environmentName": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "The environment name (e.g., dev, staging, prod)"
      }
    },
    "baseName": {
      "type": "string",
      "defaultValue": "zavastore",
      "minLength": 3,
      "maxLength": 12,
      "metadata": {
        "description": "Base name used to derive resource names"
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
    "logAnalyticsName": "[format('log-{0}-{1}-{2}', parameters('baseName'), parameters('environmentName'), take(variables('uniqueSuffix'), 6))]",
    "appInsightsName": "[format('appi-{0}-{1}-{2}', parameters('baseName'), parameters('environmentName'), take(variables('uniqueSuffix'), 6))]",
    "acrName": "[format('acr{0}{1}{2}', parameters('baseName'), parameters('environmentName'), take(variables('uniqueSuffix'), 6))]",
    "appServicePlanName": "[format('plan-{0}-{1}', parameters('baseName'), parameters('environmentName'))]",
    "webAppName": "[format('app-{0}-{1}-{2}', parameters('baseName'), parameters('environmentName'), take(variables('uniqueSuffix'), 6))]",
    "aiServicesName": "[format('ai-{0}-{1}-{2}', parameters('baseName'), parameters('environmentName'), take(variables('uniqueSuffix'), 6))]",
    "aiStorageAccountName": "[format('st{0}{1}', parameters('baseName'), take(variables('uniqueSuffix'), 8))]",
    "aiKeyVaultName": "[format('kv-{0}-{1}', parameters('baseName'), take(variables('uniqueSuffix'), 6))]",
    "aiHubName": "[format('aihub-{0}-{1}', parameters('baseName'), parameters('environmentName'))]",
    "aiProjectName": "[format('aiproj-{0}-{1}', parameters('baseName'), parameters('environmentName'))]"
  },
  "resources": {
    "logAnalytics": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('logAnalytics-{0}', uniqueString('logAnalytics', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceName": {
            "value": "[variables('logAnalyticsName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "2627100762065479382"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for the Log Analytics workspace"
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Log Analytics workspace"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('workspaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('workspaceName')]"
            }
          }
        }
      }
    },
    "appInsights": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('appInsights-{0}', uniqueString('appInsights', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalytics').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "4003299992556309080"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for Application Insights"
              }
            },
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Application Insights resource"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "The Log Analytics workspace resource ID"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]"
              }
            }
          ],
          "outputs": {
            "connectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('appInsightsName')]"
            },
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "logAnalytics"
      ]
    },
    "acr": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('acr-{0}', uniqueString('acr', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "acrName": {
            "value": "[variables('acrName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "5579138880221442640"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for the Azure Container Registry"
              }
            },
            "acrName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Container Registry (alphanumeric only)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('acrName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "adminUserEnabled": false
              }
            }
          ],
          "outputs": {
            "loginServer": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2023-07-01').loginServer]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('acrName')]"
            },
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
            }
          }
        }
      }
    },
    "appService": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('appService-{0}', uniqueString('appService', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appServicePlanName": {
            "value": "[variables('appServicePlanName')]"
          },
          "webAppName": {
            "value": "[variables('webAppName')]"
          },
          "acrLoginServer": {
            "value": "[reference('acr').outputs.loginServer.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference('appInsights').outputs.connectionString.value]"
          },
          "appInsightsInstrumentationKey": {
            "value": "[reference('appInsights').outputs.instrumentationKey.value]"
          },
          "aiServicesEndpoint": {
            "value": "[reference('aiFoundry').outputs.aiServicesEndpoint.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "1461667593230974018"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for the App Service resources"
              }
            },
            "appServicePlanName": {
              "type": "string",
              "metadata": {
                "description": "The name of the App Service Plan"
              }
            },
            "webAppName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Web App"
              }
            },
            "acrLoginServer": {
              "type": "string",
              "metadata": {
                "description": "The ACR login server URL (e.g., myacr.azurecr.io)"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string for monitoring"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "aiServicesEndpoint": {
              "type": "string",
              "metadata": {
                "description": "The Azure AI Services endpoint URL"
              }
            },
            "aiModelDeploymentName": {
              "type": "string",
              "defaultValue": "phi-4",
              "metadata": {
                "description": "The AI model deployment name"
              }
            },
            "dockerImageName": {
              "type": "string",
              "defaultValue": "zava-storefront",
              "metadata": {
                "description": "The Docker image name (without registry prefix or tag)"
              }
            },
            "dockerImageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "The Docker image tag"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2024-04-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "kind": "linux",
              "sku": {
                "name": "B1",
                "tier": "Basic"
              },
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app,linux,container",
              "tags": {
                "azd-service-name": "web"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "[format('DOCKER|{0}/{1}:{2}', parameters('acrLoginServer'), parameters('dockerImageName'), parameters('dockerImageTag'))]",
                  "acrUseManagedIdentityCreds": true,
                  "alwaysOn": true,
                  "appSettings": [
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('appInsightsInstrumentationKey')]"
                    },
                    {
                      "name": "DOCKER_REGISTRY_SERVER_URL",
                      "value": "[format('https://{0}', parameters('acrLoginServer'))]"
                    },
                    {
                      "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                      "value": "false"
                    },
                    {
                      "name": "AzureAI__Endpoint",
                      "value": "[parameters('aiServicesEndpoint')]"
                    },
                    {
                      "name": "AzureAI__ModelDeploymentName",
                      "value": "[parameters('aiModelDeploymentName')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
              ]
            }
          ],
          "outputs": {
            "webAppName": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "webAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2024-04-01').defaultHostName)]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2024-04-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "acr",
        "aiFoundry",
        "appInsights"
      ]
    },
    "acrPullRole": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('acrPullRole-{0}', uniqueString('acrPullRole', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference('appService').outputs.principalId.value]"
          },
          "acrName": {
            "value": "[reference('acr').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "7114611595407260630"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the managed identity to assign the AcrPull role to"
              }
            },
            "acrName": {
              "type": "string",
              "metadata": {
                "description": "The name of the existing ACR resource to grant pull access on"
              }
            }
          },
          "variables": {
            "acrPullRoleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), parameters('principalId'), variables('acrPullRoleDefinitionId'))]",
              "properties": {
                "principalId": "[parameters('principalId')]",
                "roleDefinitionId": "[variables('acrPullRoleDefinitionId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "acr",
        "appService"
      ]
    },
    "aiFoundry": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('aiFoundry-{0}', uniqueString('aiFoundry', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "aiServicesName": {
            "value": "[variables('aiServicesName')]"
          },
          "storageAccountName": {
            "value": "[variables('aiStorageAccountName')]"
          },
          "keyVaultName": {
            "value": "[variables('aiKeyVaultName')]"
          },
          "aiHubName": {
            "value": "[variables('aiHubName')]"
          },
          "aiProjectName": {
            "value": "[variables('aiProjectName')]"
          },
          "appInsightsId": {
            "value": "[reference('appInsights').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "17539261052214200028"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "The location for AI resources"
              }
            },
            "aiServicesName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Azure AI Services account"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Storage Account for AI Foundry Hub"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault for AI Foundry Hub"
              }
            },
            "aiHubName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry Hub"
              }
            },
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry Project"
              }
            },
            "appInsightsId": {
              "type": "string",
              "metadata": {
                "description": "The Application Insights resource ID (for AI Hub telemetry)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "accessTier": "Hot",
                "allowSharedKeyAccess": false
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-10-01",
              "name": "[parameters('aiServicesName')]",
              "location": "[parameters('location')]",
              "kind": "AIServices",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[parameters('aiServicesName')]",
                "publicNetworkAccess": "Enabled",
                "disableLocalAuth": true
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('aiServicesName'), 'gpt-4.1')]",
              "sku": {
                "name": "Standard",
                "capacity": 10
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-4.1"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('aiServicesName'), 'phi-4')]",
              "sku": {
                "name": "GlobalStandard",
                "capacity": 1
              },
              "properties": {
                "model": {
                  "format": "Microsoft",
                  "name": "Phi-4-mini-instruct",
                  "version": "1"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', parameters('aiServicesName'), 'gpt-4.1')]"
              ]
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2024-10-01",
              "name": "[parameters('aiHubName')]",
              "location": "[parameters('location')]",
              "kind": "Hub",
              "sku": {
                "name": "Basic",
                "tier": "Basic"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "friendlyName": "Zava Storefront AI Hub",
                "description": "AI Foundry hub for ZavaStorefront dev environment",
                "storageAccount": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
                "keyVault": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                "applicationInsights": "[parameters('appInsightsId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces/connections",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('aiHubName'), 'ai-services-connection')]",
              "properties": {
                "category": "AIServices",
                "target": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), '2024-10-01').endpoint]",
                "authType": "AAD",
                "isSharedToAll": true,
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]"
              ]
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2024-10-01",
              "name": "[parameters('aiProjectName')]",
              "location": "[parameters('location')]",
              "kind": "Project",
              "sku": {
                "name": "Basic",
                "tier": "Basic"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "friendlyName": "Zava Storefront AI Project",
                "description": "AI Foundry project for ZavaStorefront dev environment",
                "hubResourceId": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiHubName'))]"
              ]
            }
          ],
          "outputs": {
            "aiServicesEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), '2024-10-01').endpoint]"
            },
            "aiServicesId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]"
            },
            "aiServicesName": {
              "type": "string",
              "value": "[parameters('aiServicesName')]"
            },
            "aiHubName": {
              "type": "string",
              "value": "[parameters('aiHubName')]"
            },
            "aiProjectName": {
              "type": "string",
              "value": "[parameters('aiProjectName')]"
            }
          }
        }
      },
      "dependsOn": [
        "appInsights"
      ]
    },
    "aiServicesRole": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('aiServicesRole-{0}', uniqueString('aiServicesRole', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference('appService').outputs.principalId.value]"
          },
          "aiServicesName": {
            "value": "[reference('aiFoundry').outputs.aiServicesName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "13858746495474773039"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the managed identity to assign the Cognitive Services User role to"
              }
            },
            "aiServicesName": {
              "type": "string",
              "metadata": {
                "description": "The name of the existing Azure AI Services account"
              }
            }
          },
          "variables": {
            "cognitiveServicesUserRoleId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), parameters('principalId'), variables('cognitiveServicesUserRoleId'))]",
              "properties": {
                "principalId": "[parameters('principalId')]",
                "roleDefinitionId": "[variables('cognitiveServicesUserRoleId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "aiFoundry",
        "appService"
      ]
    }
  },
  "outputs": {
    "AZURE_CONTAINER_REGISTRY_ENDPOINT": {
      "type": "string",
      "value": "[reference('acr').outputs.loginServer.value]"
    },
    "AZURE_CONTAINER_REGISTRY_NAME": {
      "type": "string",
      "value": "[reference('acr').outputs.name.value]"
    },
    "AZURE_APP_SERVICE_WEB_NAME": {
      "type": "string",
      "value": "[reference('appService').outputs.webAppName.value]"
    },
    "WEB_URI": {
      "type": "string",
      "value": "[reference('appService').outputs.webAppUrl.value]"
    },
    "AZURE_APP_INSIGHTS_NAME": {
      "type": "string",
      "value": "[reference('appInsights').outputs.name.value]"
    },
    "AZURE_AI_SERVICES_ENDPOINT": {
      "type": "string",
      "value": "[reference('aiFoundry').outputs.aiServicesEndpoint.value]"
    },
    "AZURE_AI_HUB_NAME": {
      "type": "string",
      "value": "[reference('aiFoundry').outputs.aiHubName.value]"
    },
    "AZURE_AI_PROJECT_NAME": {
      "type": "string",
      "value": "[reference('aiFoundry').outputs.aiProjectName.value]"
    }
  }
}